# Export the module function if it exists
[[ $(type -t module) == "function" ]] && export -f module

#
#
<%- if !context.custom_desktop.to_i.zero? -%> 
## create custom desktop folder
export DESKTOP_FOLDER="${PWD}/desktop"
export XDG_DESKTOP_DIR=$DESKTOP_FOLDER
mkdir -p $DESKTOP_FOLDER

## create an icon for the terminal 
cat > $DESKTOP_FOLDER/terminal.desktop <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Exec=exo-open --launch TerminalEmulator
Icon=utilities-terminal
StartupNotify=true
Terminal=false
Categories=Utility;X-XFCE;X-Xfce-Toplevel;
OnlyShowIn=XFCE;
Name=Terminal
Comment=Use the command line
EOF

chmod +x $DESKTOP_FOLDER/terminal.desktop

## create the configuration folder
export XDG_CONFIG_HOME=$PWD/config
mkdir -p $XDG_CONFIG_HOME
export XDG_CONFIG_DIRS=$XDG_CONFIG_HOME

## we set a separate desktop folder, but unique Documents , etc etc 
cat > $XDG_CONFIG_DIRS/user-dirs.dirs  <<EOF
XDG_DESKTOP_DIR="$DESKTOP_FOLDER"
XDG_DOCUMENTS_DIR="$HOME/Documents"
XDG_DOWNLOAD_DIR="$HOME/Downloads"
XDG_MUSIC_DIR="$HOME/Music"
XDG_PICTURES_DIR="$HOME/Pictures"
XDG_PUBLICSHARE_DIR="$HOME/Public"
XDG_TEMPLATES_DIR="$HOME/Templates"
XDG_VIDEOS_DIR="$HOME/Videos"
EOF

## configure the panel so not to display removable folders
export PANEL_CONFIG=$XDG_CONFIG_DIRS/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
mkdir -p "$(dirname "${PANEL_CONFIG}")"
cat > $PANEL_CONFIG <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfce4-desktop" version="1.0">
  <property name="backdrop" type="empty">
    <property name="screen0" type="empty">
      <property name="monitor0" type="empty">
        <property name="workspace0" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="5"/>
          <property name="last-image" type="string" value="$PWD/assets/background_fasrc.jpg"/>
        </property>
        <property name="workspace1" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="5"/>
          <property name="last-image" type="string" value="/usr/share/backgrounds/images/default.png"/>
        </property>
        <property name="workspace2" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="5"/>
          <property name="last-image" type="string" value="/usr/share/backgrounds/images/default.png"/>
        </property>
        <property name="workspace3" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="5"/>
          <property name="last-image" type="string" value="/usr/share/backgrounds/images/default.png"/>
        </property>
      </property>
    </property>
  </property>
  <property name="desktop-icons" type="empty">
    <property name="file-icons" type="empty">
      <property name="show-removable" type="bool" value="false"/>
    </property>
  </property>
</channel>
EOF

<%- else -%>
## refer back to default central configuration
export XDG_CONFIG_HOME=$HOME/.config
mkdir -p $XDG_CONFIG_HOME
export XDG_DESKTOP_DIR=$HOME/Desktop
export DESKTOP_FOLDER=$XDG_DESKTOP_DIR
<%- end -%>


module purge

<%- if !context.matlab_version.include?("NULL") -%>
## create icon for Matlab (if selected)
#

matlab_ver=$(echo <%=context.matlab_version %> | sed 's/.*\/\(.*\)-fasrc.*/\1/' )
export matlab_icon=<%= session.staged_root.join("assets", "matlab.png") %>
export matlab_script=<%= session.staged_root.join("scripts", "my_matlab.sh") %>

cat > $DESKTOP_FOLDER/Matlab.desktop <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Exec=$matlab_script
Icon=$matlab_icon
Terminal=false
Name=Matlab_$matlab_ver
Comment=Startup Matlab version $matlab_ver
EOF

chmod +x $DESKTOP_FOLDER/Matlab.desktop

<%- end -%>

<%- if !context.rstudio_version.include?("NULL") -%>
## create icon for Rstudio (if selected)
#

r_ver=$(echo <%=context.r_version %> | sed 's/.*\/\(.*\)-fasrc.*/\1/' )
export rstudio_icon=<%= session.staged_root.join("assets", "rstudio.png") %>
export rstudio_script=<%= session.staged_root.join("scripts", "my_rstudio.sh") %>

cat > $DESKTOP_FOLDER/Rstudio.desktop <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Exec=$rstudio_script
Icon=$rstudio_icon
Terminal=false
Name=Rstudio and R $r_ver
Comment=Startup Rstudio and R version $r_ver 
EOF

chmod +x $DESKTOP_FOLDER/Rstudio.desktop

<%- end -%>



